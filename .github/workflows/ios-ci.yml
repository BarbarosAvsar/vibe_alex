name: iOS Release CI

# Required GitHub Secrets for both variants
#   APPLE_TEAM_ID                       -> 10-character Apple Developer Team ID used for signing/export.
#   APPLE_KEYCHAIN_PASSWORD             -> Arbitrary password for the temporary macOS keychain that stores the imported certificate.
#   APPLE_CERTIFICATE_P12_BASE64        -> Base64 of the Apple Distribution .p12.
#   APPLE_CERTIFICATE_PASSWORD          -> Password that protects the .p12 file.
#   APPLE_PROVISIONING_PROFILE_BASE64   -> Base64 of the App Store provisioning profile (.mobileprovision).
#   APPLE_PROVISIONING_PROFILE_NAME     -> Provisioning profile name / specifier referenced during archive & export.
#   APP_STORE_CONNECT_API_KEY_ID        -> Key ID from App Store Connect API key.
#   APP_STORE_CONNECT_ISSUER_ID         -> Issuer ID from App Store Connect API key.
#   APP_STORE_CONNECT_API_KEY_BASE64    -> Base64 of the AuthKey_<KEYID>.p8 file downloaded from App Store Connect.
# Optional / recommended secrets
#   TESTFLIGHT_EXTERNAL_GROUPS          -> Comma-separated TestFlight group names (used when enabling external distribution via fastlane).
#   TESTFLIGHT_CHANGELOG                -> Override changelog text (defaults to the commit message).
# Variant selector (repository variable):
#   Create a repository variable named IOS_CI_VARIANT with one of "xcodebuild", "fastlane", or "both".
#   An empty/undefined variable defaults to running Variant A (pure xcodebuild).

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
      - 'ios-*'
  workflow_dispatch:
    inputs:
      use_variant:
        description: "Optional override per manual run: xcodebuild | fastlane | both"
        required: false
        type: choice
        default: xcodebuild
        options:
          - xcodebuild
          - fastlane
          - both

env:
  PROJECT_PATH: CRISIS/CRISIS.xcodeproj
  SCHEME: CRISIS
  BUNDLE_IDENTIFIER: de.vibecode.vermoegenskompass
  APP_NAME: CRISIS
  ARCHIVE_PATH: build/CRISIS.xcarchive
  IPA_PATH: build/CRISIS.ipa
  EXPORT_OPTIONS_PATH: ExportOptions.plist

jobs:
  variant_a_xcodebuild:
    name: Variant A - xcodebuild / altool
    runs-on: macos-latest
    if: ${{ !vars.IOS_CI_VARIANT || vars.IOS_CI_VARIANT == 'xcodebuild' || vars.IOS_CI_VARIANT == 'both' || inputs.use_variant == 'xcodebuild' || inputs.use_variant == 'both' }}
    env:
      KEYCHAIN_PASSWORD: ${{ secrets.APPLE_KEYCHAIN_PASSWORD }}
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Check signing secrets
        id: signing
        run: |
          missing=0
          if [ -z "${{ secrets.APPLE_TEAM_ID }}" ]; then missing=1; fi
          if [ -z "${{ secrets.APPLE_KEYCHAIN_PASSWORD }}" ]; then missing=1; fi
          if [ -z "${{ secrets.APPLE_CERTIFICATE_P12_BASE64 }}" ]; then missing=1; fi
          if [ -z "${{ secrets.APPLE_CERTIFICATE_PASSWORD }}" ]; then missing=1; fi
          if [ -z "${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 }}" ]; then missing=1; fi
          if [ -z "${{ secrets.APPLE_PROVISIONING_PROFILE_NAME }}" ]; then missing=1; fi
          if [ -z "${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}" ]; then missing=1; fi
          if [ -z "${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}" ]; then missing=1; fi
          if [ -z "${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}" ]; then missing=1; fi
          if [ "$missing" -eq 1 ]; then
            echo "enabled=false" >> "$GITHUB_OUTPUT"
          else
            echo "enabled=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Skip release steps (missing secrets)
        if: ${{ steps.signing.outputs.enabled != 'true' }}
        run: echo "Signing secrets missing; skipping release steps."

      - name: Check signing secrets
        id: signing
        run: |
          missing=0
          if [ -z "${{ secrets.APPLE_TEAM_ID }}" ]; then missing=1; fi
          if [ -z "${{ secrets.APPLE_KEYCHAIN_PASSWORD }}" ]; then missing=1; fi
          if [ -z "${{ secrets.APPLE_CERTIFICATE_P12_BASE64 }}" ]; then missing=1; fi
          if [ -z "${{ secrets.APPLE_CERTIFICATE_PASSWORD }}" ]; then missing=1; fi
          if [ -z "${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 }}" ]; then missing=1; fi
          if [ -z "${{ secrets.APPLE_PROVISIONING_PROFILE_NAME }}" ]; then missing=1; fi
          if [ -z "${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}" ]; then missing=1; fi
          if [ -z "${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}" ]; then missing=1; fi
          if [ -z "${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}" ]; then missing=1; fi
          if [ "$missing" -eq 1 ]; then
            echo "enabled=false" >> "$GITHUB_OUTPUT"
          else
            echo "enabled=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Skip release steps (missing secrets)
        if: ${{ steps.signing.outputs.enabled != 'true' }}
        run: echo "Signing secrets missing; skipping release steps."

      - name: Select Xcode
        run: |
          if [ -d "/Applications/Xcode_15.4.app" ]; then
            sudo xcode-select -s "/Applications/Xcode_15.4.app/Contents/Developer"
          else
            echo "Xcode_15.4.app not found; using default Xcode"
            sudo xcode-select -s "/Applications/Xcode.app/Contents/Developer"
          fi

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Create custom keychain and import signing certificate
        if: ${{ steps.signing.outputs.enabled == 'true' }}
        env:
          P12: ${{ secrets.APPLE_CERTIFICATE_P12_BASE64 }}
          P12_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          if [ -z "$P12" ]; then
            echo "APPLE_CERTIFICATE_P12_BASE64 is not configured" >&2
            exit 1
          fi
          KEYCHAIN_PATH="$RUNNER_TEMP/app-signing.keychain-db"
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH" $(security list-keychain -d user | sed 's/"//g')
          CERT_PATH="$RUNNER_TEMP/signing_cert.p12"
          echo "$P12" | base64 --decode > "$CERT_PATH"
          security import "$CERT_PATH" -k "$KEYCHAIN_PATH" -P "$P12_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

      - name: Install provisioning profile
        if: ${{ steps.signing.outputs.enabled == 'true' }}
        env:
          PROFILE: ${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 }}
          PROFILE_NAME: ${{ secrets.APPLE_PROVISIONING_PROFILE_NAME }}
        run: |
          if [ -z "$PROFILE" ]; then
            echo "APPLE_PROVISIONING_PROFILE_BASE64 is not configured" >&2
            exit 1
          fi
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          PROFILE_PATH="$HOME/Library/MobileDevice/Provisioning Profiles/${PROFILE_NAME// /_}.mobileprovision"
          echo "$PROFILE" | base64 --decode > "$PROFILE_PATH"
          echo "Provisioning profile installed at $PROFILE_PATH"
          echo "PROVISIONING_PROFILE_PATH=$PROFILE_PATH" >> $GITHUB_ENV

      - name: Materialize App Store Connect API key file (for altool upload)
        if: ${{ steps.signing.outputs.enabled == 'true' }}
        run: |
          mkdir -p "$HOME/private_keys"
          KEY_PATH="$HOME/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}.p8"
          echo "${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}" | base64 --decode > "$KEY_PATH"
          chmod 600 "$KEY_PATH"
          echo "App Store Connect API key written to $KEY_PATH"

      - name: Resolve Swift Package dependencies
        run: xcodebuild -resolvePackageDependencies -project "$PROJECT_PATH" -scheme "$SCHEME"

      - name: Create ExportOptions.plist
        if: ${{ steps.signing.outputs.enabled == 'true' }}
        env:
          TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          PROFILE_NAME: ${{ secrets.APPLE_PROVISIONING_PROFILE_NAME }}
        run: |
          cat <<EOF > "$EXPORT_OPTIONS_PATH"
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store</string>
            <key>signingStyle</key>
            <string>manual</string>
            <key>stripSwiftSymbols</key>
            <true/>
            <key>teamID</key>
            <string>${TEAM_ID}</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>${BUNDLE_IDENTIFIER}</key>
              <string>${PROFILE_NAME}</string>
            </dict>
          </dict>
          </plist>
          EOF

      - name: Archive app (Release)
        if: ${{ steps.signing.outputs.enabled == 'true' }}
        env:
          TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          PROFILE_NAME: ${{ secrets.APPLE_PROVISIONING_PROFILE_NAME }}
        run: |
          set -o pipefail
          xcodebuild \
            -project "$PROJECT_PATH" \
            -scheme "$SCHEME" \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            -archivePath "$ARCHIVE_PATH" \
            DEVELOPMENT_TEAM="$TEAM_ID" \
            CODE_SIGN_STYLE=Manual \
            PROVISIONING_PROFILE_SPECIFIER="$PROFILE_NAME" \
            clean archive | xcpretty

      - name: Export signed .ipa
        if: ${{ steps.signing.outputs.enabled == 'true' }}
        run: |
          mkdir -p build
          xcodebuild -exportArchive \
            -archivePath "$ARCHIVE_PATH" \
            -exportPath build \
            -exportOptionsPlist "$EXPORT_OPTIONS_PATH"

      - name: Upload to TestFlight via altool
        if: ${{ steps.signing.outputs.enabled == 'true' }}
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          xcrun altool --upload-app \
            -f "$IPA_PATH" \
            --type ios \
            --apiKey "$ASC_KEY_ID" \
            --apiIssuer "$ASC_ISSUER_ID"

      - name: Upload artifacts (ipa + xcarchive)
        if: ${{ always() && steps.signing.outputs.enabled == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: xcodebuild-artifacts
          path: |
            ${{ env.IPA_PATH }}
            ${{ env.ARCHIVE_PATH }}
            ${{ env.EXPORT_OPTIONS_PATH }}

  variant_b_fastlane:
    name: Variant B - Fastlane lane
    runs-on: macos-latest
    needs: []
    if: ${{ vars.IOS_CI_VARIANT == 'fastlane' || vars.IOS_CI_VARIANT == 'both' || inputs.use_variant == 'fastlane' || inputs.use_variant == 'both' }}
    env:
      KEYCHAIN_PASSWORD: ${{ secrets.APPLE_KEYCHAIN_PASSWORD }}
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Select Xcode
        run: |
          if [ -d "/Applications/Xcode_15.4.app" ]; then
            sudo xcode-select -s "/Applications/Xcode_15.4.app/Contents/Developer"
          else
            echo "Xcode_15.4.app not found; using default Xcode"
            sudo xcode-select -s "/Applications/Xcode.app/Contents/Developer"
          fi

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Create custom keychain and import signing certificate
        if: ${{ steps.signing.outputs.enabled == 'true' }}
        env:
          P12: ${{ secrets.APPLE_CERTIFICATE_P12_BASE64 }}
          P12_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          if [ -z "$P12" ]; then
            echo "APPLE_CERTIFICATE_P12_BASE64 is not configured" >&2
            exit 1
          fi
          KEYCHAIN_PATH="$RUNNER_TEMP/app-signing.keychain-db"
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH" $(security list-keychain -d user | sed 's/"//g')
          CERT_PATH="$RUNNER_TEMP/signing_cert.p12"
          echo "$P12" | base64 --decode > "$CERT_PATH"
          security import "$CERT_PATH" -k "$KEYCHAIN_PATH" -P "$P12_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

      - name: Install provisioning profile
        if: ${{ steps.signing.outputs.enabled == 'true' }}
        env:
          PROFILE: ${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 }}
          PROFILE_NAME: ${{ secrets.APPLE_PROVISIONING_PROFILE_NAME }}
        run: |
          if [ -z "$PROFILE" ]; then
            echo "APPLE_PROVISIONING_PROFILE_BASE64 is not configured" >&2
            exit 1
          fi
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          PROFILE_PATH="$HOME/Library/MobileDevice/Provisioning Profiles/${PROFILE_NAME// /_}.mobileprovision"
          echo "$PROFILE" | base64 --decode > "$PROFILE_PATH"
          echo "APP_PROVISIONING_PROFILE_PATH=$PROFILE_PATH" >> $GITHUB_ENV

      - name: Resolve Swift Package dependencies
        run: xcodebuild -resolvePackageDependencies -project "$PROJECT_PATH" -scheme "$SCHEME"

      - name: Install Ruby gems (fastlane via Bundler)
        run: |
          gem install bundler
          bundle config set path vendor/bundle
          bundle install --jobs 4 --retry 3

      - name: Materialize App Store Connect API key for fastlane
        if: ${{ steps.signing.outputs.enabled == 'true' }}
        run: |
          KEY_PATH="$RUNNER_TEMP/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}.p8"
          echo "${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}" | base64 --decode > "$KEY_PATH"
          chmod 600 "$KEY_PATH"
          echo "APP_STORE_CONNECT_API_KEY_PATH=$KEY_PATH" >> $GITHUB_ENV

      - name: Run fastlane beta lane
        if: ${{ steps.signing.outputs.enabled == 'true' }}
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_PROVISIONING_PROFILE_NAME: ${{ secrets.APPLE_PROVISIONING_PROFILE_NAME }}
          TESTFLIGHT_CHANGELOG: ${{ secrets.TESTFLIGHT_CHANGELOG || github.event.head_commit.message }}
          TESTFLIGHT_EXTERNAL_GROUPS: ${{ secrets.TESTFLIGHT_EXTERNAL_GROUPS }}
        run: |
          bundle exec fastlane beta

      - name: Upload artifacts (ipa + xcarchive)
        if: ${{ always() && steps.signing.outputs.enabled == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: fastlane-artifacts
          path: |
            build/*.ipa
            build/*.xcarchive


