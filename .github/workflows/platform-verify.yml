name: Platform Verify

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  platform-builds:
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - scheme: CRISISTahoe
            sdk_match: macosx26
            destination: "platform=macOS,arch=arm64"
            runtime_platform: ""
            device_filter: ""
          - scheme: CRISISVision
            sdk_match: xros26
            destination: ""
            runtime_platform: "visionOS"
            device_filter: "Apple Vision Pro"
          - scheme: CRISISWatch
            sdk_match: watchos26
            destination: ""
            runtime_platform: "watchOS"
            device_filter: "Apple Watch"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select latest Xcode
        run: |
          if [ -d "/Applications/Xcode_15.4.app" ]; then
            sudo xcode-select -s "/Applications/Xcode_15.4.app/Contents/Developer"
          else
            sudo xcode-select -s "/Applications/Xcode.app/Contents/Developer"
          fi

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Check SDK availability
        id: sdk
        run: |
          if xcodebuild -showsdks | tr -d '\r' | grep -q "${{ matrix.sdk_match }}"; then
            echo "available=true" >> "$GITHUB_OUTPUT"
          else
            echo "available=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Select simulator destination
        id: destination
        if: steps.sdk.outputs.available == 'true'
        shell: bash
        run: |
          python - <<'PY' >> "$GITHUB_OUTPUT"
          import json
          import os
          import subprocess

          runtime_platform = os.environ.get("RUNTIME_PLATFORM", "")
          device_filter = os.environ.get("DEVICE_FILTER", "")
          fallback_destination = os.environ.get("DESTINATION", "")

          if not runtime_platform:
              print("available=true")
              if fallback_destination:
                  print(f"destination={fallback_destination}")
              raise SystemExit(0)

          data = subprocess.check_output(["xcrun", "simctl", "list", "-j"]).decode("utf-8")
          payload = json.loads(data)
          runtimes = [
              runtime for runtime in payload.get("runtimes", [])
              if runtime.get("platform") == runtime_platform and runtime.get("isAvailable")
          ]

          def version_tuple(value):
              return tuple(int(part) for part in value.split(".") if part.isdigit())

          runtimes.sort(key=lambda runtime: version_tuple(runtime.get("version", "0")), reverse=True)
          available = False
          destination = ""

          if runtimes:
              runtime = runtimes[0]
              runtime_version = runtime.get("version", "")
              if version_tuple(runtime_version)[:1] >= (26,):
                  devices = payload.get("devices", {}).get(runtime.get("identifier", ""), [])
                  device = None
                  if device_filter:
                      device = next((item for item in devices if item.get("isAvailable") and device_filter in item.get("name", "")), None)
                  if device is None:
                      device = next((item for item in devices if item.get("isAvailable")), None)
                  if device:
                      available = True
                      destination = f"id={device.get('udid')}"

          print(f"available={'true' if available else 'false'}")
          if destination:
              print(f"destination={destination}")
          PY
        env:
          RUNTIME_PLATFORM: ${{ matrix.runtime_platform }}
          DEVICE_FILTER: ${{ matrix.device_filter }}
          DESTINATION: ${{ matrix.destination }}

      - name: Skip build (SDK unavailable)
        if: steps.sdk.outputs.available != 'true'
        run: |
          echo "SDK '${{ matrix.sdk_match }}' not available; skipping ${{ matrix.scheme }}."

      - name: Skip build (no simulator)
        if: steps.sdk.outputs.available == 'true' && steps.destination.outputs.available != 'true'
        run: |
          echo "No simulator runtime available for ${{ matrix.scheme }}; skipping."

      - name: Verify signing and entitlements
        if: steps.sdk.outputs.available == 'true' && steps.destination.outputs.available == 'true'
        run: |
          set -euo pipefail
          settings=$(xcodebuild -project CRISIS/CRISIS.xcodeproj -scheme "${{ matrix.scheme }}" -showBuildSettings | tr -d '\r')
          entitlements=$(echo "$settings" | awk -F ' = ' '/CODE_SIGN_ENTITLEMENTS/ {print $2; exit}')
          code_sign_style=$(echo "$settings" | awk -F ' = ' '/CODE_SIGN_STYLE/ {print $2; exit}')
          bundle_id=$(echo "$settings" | awk -F ' = ' '/PRODUCT_BUNDLE_IDENTIFIER/ {print $2; exit}')

          if [ -z "$code_sign_style" ]; then
            echo "CODE_SIGN_STYLE not set for ${{ matrix.scheme }}" >&2
            exit 1
          fi

          if [ -z "$bundle_id" ]; then
            echo "PRODUCT_BUNDLE_IDENTIFIER not set for ${{ matrix.scheme }}" >&2
            exit 1
          fi

          if [ -n "$entitlements" ] && [ ! -f "$entitlements" ]; then
            echo "Entitlements file missing: $entitlements" >&2
            exit 1
          fi

      - name: Test target
        if: steps.sdk.outputs.available == 'true' && steps.destination.outputs.available == 'true'
        run: |
          set -o pipefail
          xcodebuild \
            -project CRISIS/CRISIS.xcodeproj \
            -scheme "${{ matrix.scheme }}" \
            -destination "${{ steps.destination.outputs.destination }}" \
            CODE_SIGNING_ALLOWED=NO \
            test
